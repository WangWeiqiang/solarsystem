<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Three.js</title>
        <script src="js/three.min.js"></script>
        <script src="js/TrackballControls.js"></script>
        <style type="text/css">
            div#canvas-frame{
              border: none;
              cursor: pointer;
              width: 600px;
              height: 600px;
              background-color: #EEEEEE;
            }
        </style>
        <script>
            var container, stats;
            var camera, scene, renderer;
            var group;
            var mouseX = 0, mouseY = 0;
            var directionalLight;
            var windowHalfX = window.innerWidth / 2;
            var windowHalfY = window.innerHeight / 2;

            var radius = 6371;
            var tilt = 0.41;
            var rotationSpeed = 0.02;

            var cloudsScale = 1.005;
            var moonScale = 0.13;

            var MARGIN = 0;
            var SCREEN_HEIGHT = window.innerHeight - MARGIN * 2;
            var SCREEN_WIDTH = window.innerWidth;

            var container, stats;
            var camera, controls, scene, sceneCube, renderer;
            var geometry, meshPlanet, meshClouds, meshMoon, meshSun;
            var dirLight, pointLight, ambientLight;

            var d, dPlanet, dMoon, dMoonVec = new THREE.Vector3();
            var clock = new THREE.Clock();
            var camGroup;
            var controls;
            var projector;
            var objects = [];
            var moonPivot;
            function init() {
                scene = new THREE.Scene();
                container = document.getElementById("box");
                camera = new THREE.PerspectiveCamera(25, SCREEN_WIDTH / SCREEN_HEIGHT, 50, 1e7);
                camera.position.z = radius * 10;

                controls = new THREE.TrackballControls(camera);
                controls.addEventListener('change', render);
                //scene.fog = new THREE.FogExp2(0x000000, 0.0000015);

                dirLight = new THREE.DirectionalLight(0xffffff);
                dirLight.position.set(1, 0, 0).normalize();
                scene.add(dirLight);

                ambientLight = new THREE.AmbientLight(0x000000);
                scene.add(ambientLight);

                var planetTexture = THREE.ImageUtils.loadTexture("images/earth_atmos_2048.jpg");
                var cloudsTexture = THREE.ImageUtils.loadTexture("images/earth_clouds_1024.png");
                var normalTexture = THREE.ImageUtils.loadTexture("images/earth_normal_2048.jpg");
                var specularTexture = THREE.ImageUtils.loadTexture("images/earth_specular_2048.jpg");

                var moonTexture = THREE.ImageUtils.loadTexture("images/moon_1024.jpg");
                var sunTexture = THREE.ImageUtils.loadTexture("images/sun.png");
                var shader = THREE.ShaderUtils.lib["normal"];
                var uniforms = THREE.UniformsUtils.clone(shader.uniforms);

                uniforms["tNormal"].value = normalTexture;
                uniforms["uNormalScale"].value.set(0.85, 0.85);

                uniforms["tDiffuse"].value = planetTexture;
                uniforms["tSpecular"].value = specularTexture;

                uniforms["enableAO"].value = false;
                uniforms["enableDiffuse"].value = true;
                uniforms["enableSpecular"].value = true;

                uniforms["uDiffuseColor"].value.setHex(0xffffff);
                uniforms["uSpecularColor"].value.setHex(0x333333);
                uniforms["uAmbientColor"].value.setHex(0x000000);

                uniforms["uShininess"].value = 15;

                var parameters = {
                    fragmentShader: shader.fragmentShader,
                    vertexShader: shader.vertexShader,
                    uniforms: uniforms,
                    lights: true,
                    fog: true
                };

                var materialNormalMap = new THREE.ShaderMaterial(parameters);

                // planet
                geometry = new THREE.SphereGeometry(radius, 100, 50);
                geometry.computeTangents();
                meshPlanet = new THREE.Mesh(geometry, materialNormalMap);
                meshPlanet.rotation.y = 0;
                meshPlanet.rotation.z = tilt;
                scene.add(meshPlanet);
                objects.push(meshPlanet);
                // clouds
                var materialClouds = new THREE.MeshLambertMaterial({ color: 0xffffff, map: cloudsTexture, transparent: true });
                meshClouds = new THREE.Mesh(geometry, materialClouds);
                meshClouds.scale.set(cloudsScale, cloudsScale, cloudsScale);
                meshClouds.rotation.z = tilt;
                scene.add(meshClouds);
                objects.push(meshClouds);

                moonPivot = new THREE.Object3D();
                meshPlanet.add(moonPivot);


                // moon
                var materialMoon = new THREE.MeshPhongMaterial({ color: 0xffffff, map: moonTexture });
                meshMoon = new THREE.Mesh(geometry, materialMoon);
                meshMoon.position.set(0, 0, radius *10);
                meshMoon.scale.set(moonScale, moonScale, moonScale);
                scene.add(meshMoon);
                objects.push(meshMoon);
                moonPivot.add(meshMoon);

                // sun
                var mterialSun = new THREE.MeshPhongMaterial({ color: 0xffffff, map: sunTexture });
                meshSun = new THREE.Mesh(geometry, mterialSun);
                meshSun.position.set(radius * 10, 0, 0);
                meshSun.scale.set(moonScale, moonScale, moonScale);
                //scene.add(meshSun);
                // stars
                var i, r = radius * 10, starsGeometry = [new THREE.Geometry(), new THREE.Geometry()];
                for(i = 0; i < 250; i++) {
                    var vertex = new THREE.Vector3();
                    vertex.x = Math.random() * 2 - 1;
                    vertex.y = Math.random() * 2 - 1;
                    vertex.z = Math.random() * 2 - 1;
                    vertex.multiplyScalar(r);
                    starsGeometry[0].vertices.push(vertex);
                }

                for(i = 0; i < 15000; i++) {
                    var vertex = new THREE.Vector3();
                    vertex.x = Math.random() * 2 - 1;
                    vertex.y = Math.random() * 2 - 1;
                    vertex.z = Math.random() * 2 - 1;
                    vertex.multiplyScalar(r);
                    starsGeometry[1].vertices.push(vertex);
                }

                var stars;
                var starsMaterials = [new THREE.ParticleBasicMaterial({ color: 0x555555, size: 2, sizeAttenuation: false }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      new THREE.ParticleBasicMaterial({ color: 0x555555, size: 1, sizeAttenuation: false }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      new THREE.ParticleBasicMaterial({ color: 0x333333, size: 2, sizeAttenuation: false }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      new THREE.ParticleBasicMaterial({ color: 0x3a3a3a, size: 1, sizeAttenuation: false }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      new THREE.ParticleBasicMaterial({ color: 0x1a1a1a, size: 2, sizeAttenuation: false }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      new THREE.ParticleBasicMaterial({ color: 0x1a1a1a, size: 1, sizeAttenuation: false })
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ];

                for(i = 10; i < 30; i++) {

                    stars = new THREE.ParticleSystem(starsGeometry[i % 2], starsMaterials[i % 6]);

                    stars.rotation.x = Math.random() * 6;
                    stars.rotation.y = Math.random() * 6;
                    stars.rotation.z = Math.random() * 6;

                    s = i * 10;
                    stars.scale.set(s, s, s);

                    stars.matrixAutoUpdate = false;
                    stars.updateMatrix();

                    scene.add(stars);

                }

                renderer = new THREE.WebGLRenderer({ clearColor: 0x000000, clearAlpha: 1 });
                renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
                renderer.sortObjects = false;
                renderer.autoClear = false;
                container.appendChild(renderer.domElement);
                projector = new THREE.Projector();
                window.addEventListener('resize', onWindowResize, false);
                window.addEventListener('mousemove', onDocumentMouseMove, false);
                window.addEventListener('mousedown', onDocumentMouseDown, false);
                window.addEventListener('mouseup', onDocumentMouseUp, false);
                window.addEventListener('dblclick', onDbClick, false);
            }

            function onWindowResize() {
                windowHalfX = window.innerWidth / 2;
                windowHalfY = window.innerHeight / 2;
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
            var startDrogPos = new Object(), MouseDown = false;
            startDrogPos.x = 0;
            startDrogPos.y = 0;

            var movex = 0, movey = 0;
            function onDocumentMouseMove(event) {
                if(MouseDown) {
                    mouseX = (event.clientX - windowHalfX);
                    mouseY = (event.clientY - windowHalfY);
                    mouseXPercent = Math.ceil((mouseX / windowHalfX) * 100);
                    mouseYPercent = Math.ceil((mouseY / windowHalfY) * 100);
                    movex += mouseX;
                    movey += mouseY;
                    camera.position.x += Math.sin(movex / radius) * 10;
                    camera.position.y += Math.sin(movey / radius) * 10;
                    console.log(camera.position.x);
                    render();
                }

            }
            function onDocumentMouseDown(event) {
                startDrogPos.x = event.clientX - windowHalfX;
                startDrogPos.y = event.clientY - windowHalfY;
                MouseDown = true;
            }
            function onDocumentMouseUp(event) {
                MouseDown = false;
                startDrogPos.x = 0;
                startDrogPos.y = 0;
            }

            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                render();
            }

            function render() {

                // rotate the planet and clouds
                var delta = clock.getDelta();
                meshPlanet.rotation.y += rotationSpeed * delta;
                meshClouds.rotation.y += 1.25 * rotationSpeed * delta;
                moonPivot.rotation.y += 0.1 * rotationSpeed * delta;
                // slow down as we approach the surface
                dPlanet = camera.position.length();
                dMoonVec.sub(camera.position, meshMoon.position);
                dMoon = dMoonVec.length();

                if(dMoon < dPlanet) {
                    d = (dMoon - radius * moonScale * 1.01);
                } else {
                    d = (dPlanet - radius * 1.01);
                }


                renderer.clear();
                renderer.render(scene, camera)
            };

            function play() {
                init();
                animate();
            }

            function onDbClick(event) {
                event.preventDefault();

                var vector = new THREE.Vector3((event.clientX / window.innerWidth) * 2 - 1, -(event.clientY / window.innerHeight) * 2 + 1, 0.5);
                projector.unprojectVector(vector, camera);

                var ray = new THREE.Ray(camera.position, vector.subSelf(camera.position).normalize());

                var intersects = ray.intersectObjects(objects);

                if(intersects.length > 0) {

                    var cammerZ = (intersects[0].object.position.z + 1000);
                    camera.position.set(0, 0, cammerZ);
                    camera.lookAt(meshMoon.position);
                    console.log(meshMoon.position);
                    render();

                }
            }
    </script>
    </head>

    <body onload="play()">
        <div id="box"></div>
    </body>
</html>